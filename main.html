<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improved Cookie Banner</title>
    <style>
        /* Styles for the cookie banner */
        #cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #f0f0f0;
            padding: 15px;
            text-align: center;
            z-index: 10000;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            font-family: Arial, sans-serif;
        }
        #cookie-banner p {
            margin: 0 0 10px 0;
            font-size: 14px;
            line-height: 1.4;
        }
        #cookie-banner button {
            margin: 0 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        #cookie-accept-all {
            background: #4caf50;
            color: #fff;
        }
        #cookie-decline-all {
            background: #ccc;
            color: #000;
        }
        #cookie-customize {
            background: transparent;
            color: #0066cc;
            text-decoration: underline;
        }
        #cookie-settings {
            display: none;
            background: #fff;
            max-width: 600px;
            width: 90%;
            margin: 10px auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        #cookie-settings h2 {
            margin-top: 0;
            font-size: 18px;
        }
        .cookie-category {
            margin: 10px 0;
            border-top: 1px solid #ddd;
            padding-top: 10px;
        }
        .cookie-category:first-child {
            border-top: none;
            padding-top: 0;
        }
        .cookie-category h4 {
            margin: 0;
            font-size: 16px;
            display: inline-block;
        }
        .cookie-category .always-on {
            font-size: 12px;
            color: #555;
            font-style: italic;
            margin-left: 5px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            vertical-align: middle;
            margin-left: 10px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #4caf50;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #4caf50;
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        #cookie-preferences-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #fff;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
        }
        #cookie-preferences-btn svg {
            width: 24px;
            height: 24px;
            fill: #000;
        }
    </style>
</head>
<body>
    <!-- Cookie Banner HTML -->
    <div id="cookie-banner" role="dialog" aria-modal="true" aria-label="Cookie Einstellungen">
        <div id="cookie-initial">
            <p>Diese Website verwendet Cookies. Einige sind essenziell, andere dienen Marketing- und Analysezwecken. Sie können Ihre Einstellungen anpassen oder alle akzeptieren. Mehr in unserer <a href="/datenschutz" target="_blank" style="color:#0066cc;text-decoration:underline;">Datenschutzerklärung</a>.</p>
            <button id="cookie-accept-all" aria-label="Alle Cookies akzeptieren">Alle akzeptieren</button>
            <button id="cookie-decline-all" aria-label="Alle nicht-essenziellen Cookies ablehnen">Alle ablehnen</button>
            <button id="cookie-customize" aria-label="Cookie-Einstellungen anpassen">Einstellungen</button>
        </div>
        <div id="cookie-settings">
            <h2>Cookie-Einstellungen</h2>
            <div class="cookie-category">
                <h4>Essenzielle Cookies <span class="always-on">(immer aktiv)</span></h4>
                <p>Diese Cookies sind für die Funktion der Website erforderlich.</p>
            </div>
            <div class="cookie-category">
                <h4>Funktionale Cookies</h4>
                <label class="switch">
                    <input type="checkbox" id="toggle-functional" aria-label="Funktionale Cookies aktivieren">
                    <span class="slider"></span>
                </label>
                <p>Diese Cookies verbessern Funktionalität und Personalisierung.</p>
            </div>
            <div class="cookie-category">
                <h4>Analytische Cookies</h4>
                <label class="switch">
                    <input type="checkbox" id="toggle-analytics" aria-label="Analytische Cookies aktivieren">
                    <span class="slider"></span>
                </label>
                <p>Diese Cookies sammeln anonyme Statistiken zur Leistungsverbesserung.</p>
            </div>
            <div class="cookie-category">
                <h4>Marketing Cookies</h4>
                <label class="switch">
                    <input type="checkbox" id="toggle-marketing" aria-label="Marketing Cookies aktivieren">
                    <span class="slider"></span>
                </label>
                <p>Diese Cookies zeigen relevante Werbung und messen Kampagneneffektivität.</p>
            </div>
            <div style="text-align: right;">
                <button id="settings-save" style="background:#0066cc;color:#fff;">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Preferences icon button -->
    <button id="cookie-preferences-btn" title="Cookie-Einstellungen anpassen" aria-label="Cookie-Einstellungen öffnen">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
            <path d="M8.932.727c-.243-.97-1.62-.97-1.864 0l-.071.286a.96.96 0 0 1-1.622.434l-.205-.211c-.695-.719-1.888-.03-1.613.931l.08.284a.96.96 0 0 1-1.186 1.187l-.284-.081c-.96-.275-1.65.918-.931 1.613l.211.205a.96.96 0 0 1-.434 1.622l-.286.071c-.97.243-.97 1.62 0 1.864l.286.071a.96.96 0 0 1 .434 1.622l-.211.205c-.719.695-.03 1.888.931 1.613l.284-.08a.96.96 0 0 1 1.187 1.187l-.081.283c-.275.96.918 1.65 1.613.931l.205-.211a.96.96 0 0 1 1.622.434l.071.286c.243.97 1.62.97 1.864 0l.071-.286a.96.96 0 0 1 1.622-.434l.205.211c.695.719 1.888.03 1.613-.931l-.08-.284a.96.96 0 0 1 1.187-1.187l.283.081c.96.275 1.65-.918.931-1.613l-.211-.205a.96.96 0 0 1 .434-1.622l.286-.071c.97-.243.97-1.62 0-1.864l-.286-.071a.96.96 0 0 1-.434-1.622l.211-.205c.719-.695.03-1.888-.931-1.613l-.284.08a.96.96 0 0 1-1.187-1.186l.081-.284c.275-.96-.918-1.65-1.613-.931l-.205.211a.96.96 0 0 1-1.622-.434zM8 12.997a4.998 4.998 0 1 1 0-9.995 4.998 4.998 0 0 1 0 9.996z"/>
        </svg>
    </button>

    <script>
        // Cookie Consent Script
        (function() {
            const COOKIE_PREFERENCES_KEY = "cookieConsentSettings";
            let allowedCategories = { essential: true, functional: false, analytics: false, marketing: false };

            // Define known cookies and their categories/purpose
            const cookieInfo = {
                "_ga": { cat: "analytics", desc: "Used by Google Analytics to register a unique ID for statistical data." },
                "_gid": { cat: "analytics", desc: "Used by Google Analytics to generate statistical data." },
                "_fbp": { cat: "marketing", desc: "Used by Facebook to deliver advertising products." },
                "PHPSESSID": { cat: "essential", desc: "Stores your current session ID for site functionality." }
            };

            // Helper functions
            function getCategory(cookieName) {
                if (cookieInfo[cookieName]) return cookieInfo[cookieName].cat;
                if (cookieName.startsWith("_ga_")) return "analytics";
                return "functional"; // Default for unknown cookies
            }

            function deleteCookie(name) {
                document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/;`;
            }

            function savePreferences(prefs) {
                try {
                    localStorage.setItem(COOKIE_PREFERENCES_KEY, JSON.stringify(prefs));
                } catch (error) {
                    console.error("Error saving preferences:", error);
                }
            }

            function loadPreferences() {
                try {
                    const prefs = localStorage.getItem(COOKIE_PREFERENCES_KEY);
                    return prefs ? JSON.parse(prefs) : null;
                } catch (error) {
                    console.error("Error loading preferences:", error);
                    return null;
                }
            }

            function applyPreferences(prefs) {
                allowedCategories = prefs.categories;
                const cookies = document.cookie.split("; ");
                cookies.forEach(cookie => {
                    const [name] = cookie.split("=");
                    const cat = getCategory(name);
                    if (cat !== "essential" && !allowedCategories[cat]) deleteCookie(name);
                });
            }

            function showSettings() {
                const initial = document.getElementById("cookie-initial");
                const settings = document.getElementById("cookie-settings");
                if (initial && settings) {
                    initial.style.display = "none";
                    settings.style.display = "block";
                    const prefs = loadPreferences();
                    if (prefs) {
                        document.getElementById("toggle-functional").checked = prefs.categories.functional;
                        document.getElementById("toggle-analytics").checked = prefs.categories.analytics;
                        document.getElementById("toggle-marketing").checked = prefs.categories.marketing;
                    }
                }
            }

            function hideBanner() {
                const banner = document.getElementById("cookie-banner");
                if (banner) banner.style.display = "none";
                const prefBtn = document.getElementById("cookie-preferences-btn");
                if (prefBtn) prefBtn.style.display = "flex";
            }

            // Override document.cookie setter
            const cookieDescriptor = Object.getOwnPropertyDescriptor(Document.prototype, "cookie") || Object.getOwnPropertyDescriptor(Object.prototype, "cookie");
            const originalSetter = cookieDescriptor.set;
            Object.defineProperty(document, "cookie", {
                set: function(value) {
                    const name = value.split("=")[0];
                    const cat = getCategory(name);
                    if (cat !== "essential" && !allowedCategories[cat]) {
                        console.log("Cookie blocked: " + name);
                        return;
                    }
                    originalSetter.call(document, value);
                },
                configurable: true
            });

            // Event Listeners
            const acceptAllBtn = document.getElementById("cookie-accept-all");
            if (acceptAllBtn) {
                acceptAllBtn.addEventListener("click", () => {
                    const prefs = { consentGiven: true, categories: { essential: true, functional: true, analytics: true, marketing: true } };
                    savePreferences(prefs);
                    applyPreferences(prefs);
                    hideBanner();
                });
            }

            const declineAllBtn = document.getElementById("cookie-decline-all");
            if (declineAllBtn) {
                declineAllBtn.addEventListener("click", () => {
                    const prefs = { consentGiven: true, categories: { essential: true, functional: false, analytics: false, marketing: false } };
                    savePreferences(prefs);
                    applyPreferences(prefs);
                    hideBanner();
                });
            }

            const customizeBtn = document.getElementById("cookie-customize");
            if (customizeBtn) customizeBtn.addEventListener("click", showSettings);

            const saveSettingsBtn = document.getElementById("settings-save");
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener("click", () => {
                    const prefs = {
                        consentGiven: true,
                        categories: {
                            essential: true,
                            functional: document.getElementById("toggle-functional").checked,
                            analytics: document.getElementById("toggle-analytics").checked,
                            marketing: document.getElementById("toggle-marketing").checked
                        }
                    };
                    savePreferences(prefs);
                    applyPreferences(prefs);
                    hideBanner();
                });
            }

            const prefBtn = document.getElementById("cookie-preferences-btn");
            if (prefBtn) prefBtn.addEventListener("click", () => {
                const banner = document.getElementById("cookie-banner");
                if (banner) {
                    banner.style.display = "block";
                    showSettings();
                }
            });

            // Initialization
            const existingPrefs = loadPreferences();
            if (existingPrefs) {
                applyPreferences(existingPrefs);
                hideBanner();
            } else {
                const banner = document.getElementById("cookie-banner");
                if (banner) banner.style.display = "block";
            }
        })();
    </script>
</body>
</html>
